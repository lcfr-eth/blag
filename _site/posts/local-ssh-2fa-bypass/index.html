<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Session Riding OpenSSH (multiplexing) to bypass 2FA" />
<meta property="og:locale" content="en" />
<meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<link rel="canonical" href="http://0.0.0.0:4000/posts/local-ssh-2fa-bypass/" />
<meta property="og:url" content="http://0.0.0.0:4000/posts/local-ssh-2fa-bypass/" />
<meta property="og:site_name" content="LCFR" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-06T20:28:22-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Session Riding OpenSSH (multiplexing) to bypass 2FA" />
<meta name="twitter:site" content="@lcfr_eth" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-06T20:28:22-04:00","datePublished":"2021-06-06T20:28:22-04:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"Session Riding OpenSSH (multiplexing) to bypass 2FA","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/posts/local-ssh-2fa-bypass/"},"url":"http://0.0.0.0:4000/posts/local-ssh-2fa-bypass/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Session Riding OpenSSH (multiplexing) to bypass 2FA | LCFR
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="LCFR">
<meta name="application-name" content="LCFR">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Paradise_Lost_12.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">LCFR</a>
    <p class="site-subtitle fst-italic mb-0">nobody</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/lcfr-eth"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/lcfr_eth"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['nobody','lcfr.io'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Session Riding OpenSSH (multiplexing) to bypass 2FA</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Session Riding OpenSSH (multiplexing) to bypass 2FA</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1623025702"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  6, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/lcfr_eth">LCFR</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2387 words"
>
  <em>13 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Session Riding OpenSSH (multiplexing) to bypass 2FA</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Session Riding OpenSSH (multiplexing) to bypass 2FA</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <p><a href="https://upload.wikimedia.org/assets/img/paradise.jpeg" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/paradise.jpeg" alt="image" loading="lazy"></a></p>

<h5 id="quick-links"><span class="me-2">Quick Links</span><a href="#quick-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>
<p><a href="#what-is-ssh-session-injection">What is SSH session injection</a><br />
<a href="#a-brief-view-of-connection--session-creation-in-openssh">Brief overview of SSH session creation code</a><br />
<a href="#reading-documentation-will-make-you-a-better-hacker-">Good hackers read documentation</a><br />
<a href="#abusing-ssh-multiplexing-">Abusing SSH multiplexing</a><br />
<a href="#detection">Detection</a><br />
<a href="#eof">EOF</a></p>

<h1 id="what-is-ssh-session-injection">What is SSH session injection?</h1>

<p>Mostly personal notes after revisiting the subject recently while reminiscing on past hacking techniques.</p>

<p>In the past SSH session injection allowed an attacker to inject code into a target users ssh client process to open a new session to an already connected remote server.</p>

<p>Unknown to the legitimate user the remote server was compromised silently while they were connected in another session without the attacker modifying the sshd binary on disk.</p>

<p>Previous public work:</p>

<p>1) <a href="https://www.blackhat.com/presentations/bh-usa-05/bh-us-05-boileau.pdf">Trust Transience: Post Intrustion SSH Hijacking</a>.</p>

<p>The technique was officially patched in OpenSSH 5.1 in 2008:<br />
<a href="https://github.com/openssh/openssh-portable/commit/8901fa9c88d52ac1f099e7a3ce5bd75089e7e731#diff-6e5958092d48b108bef3faadd24f2259a7e999ba8771cb64c986179c059fe130">OpenSSH 5.1p1 Patch</a></p>

<h1 id="a-brief-view-of-connection--session-creation-in-openssh">A brief view of connection &amp; session creation in OpenSSH:</h1>

<p>A high level overview of the functions and files involved with creating a connection/session/channel are provided.</p>

<p>Starting with the server side files and functions:</p>

<h3 id="packeth"><span class="me-2">packet.h</span><a href="#packeth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The relevent part of the ssh struct we are interested in is the dispatch function table.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">ssh</span> <span class="p">{</span>
        <span class="p">...</span>
	<span class="cm">/* Dispatcher table */</span>
	<span class="n">dispatch_fn</span> <span class="o">*</span><span class="n">dispatch</span><span class="p">[</span><span class="n">DISPATCH_MAX</span><span class="p">];</span>
        <span class="p">...</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="sshdc"><span class="me-2">sshd.c</span><a href="#sshdc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The main server loop handles the client connections initial authentication and creates the <code class="language-plaintext highlighter-rouge">ssh</code> and <code class="language-plaintext highlighter-rouge">authctxt</code> objects in memory that are passed between the different session related functions.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>    <span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="p">...</span>
    <span class="c1">// XXX - main server loop that handles individual connections </span>
    <span class="p">...</span>
    <span class="c1">// XXX - called after all authentication checks have passed. </span>
    <span class="n">do_authenticated</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">authctxt</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="sessionc"><span class="me-2">session.c</span><a href="#sessionc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>After a connection passes all authentication checks in <code class="language-plaintext highlighter-rouge">sshd.c</code> its data is passed through the <code class="language-plaintext highlighter-rouge">do_authenticated(...)</code> function to the <code class="language-plaintext highlighter-rouge">do_authenticated2(...)</code> function in <code class="language-plaintext highlighter-rouge">session.c</code> before being passed to the <code class="language-plaintext highlighter-rouge">server_loop2(...)</code> function in the <code class="language-plaintext highlighter-rouge">serverloop.c</code> file.</p>

<p>Nothing very important happens in the <code class="language-plaintext highlighter-rouge">session.c</code> file for our context.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">do_authenticated</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span> <span class="n">Authctxt</span> <span class="o">*</span><span class="n">authctxt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
    <span class="n">do_authenticated2</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">authctxt</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="n">do_authenticated2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span> <span class="n">Authctxt</span> <span class="o">*</span><span class="n">authctxt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">server_loop2</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">authctxt</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="serverloopc"><span class="me-2">serverloop.c</span><a href="#serverloopc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The <code class="language-plaintext highlighter-rouge">server_loop2(...)</code> function calls a dispatch function <code class="language-plaintext highlighter-rouge">server_init_dispatch(...)</code> that sets certain handler functions depending on the <code class="language-plaintext highlighter-rouge">ssh</code> object dispatch command passed to it.</p>

<p>If the <code class="language-plaintext highlighter-rouge">SSH2_MSG_GLOBAL_REQUEST</code> ssh dispatch command is received. This function calls <code class="language-plaintext highlighter-rouge">server_input_global_request(...)</code> This command is sent by the ssh client when initiating a connection/session with a server.</p>

<p>The <code class="language-plaintext highlighter-rouge">server_input_global_request(...)</code> function checks if the client sent the <code class="language-plaintext highlighter-rouge">no-more-sessions@openssh.com</code> string and sets the <code class="language-plaintext highlighter-rouge">no_more_sessions</code> to <code class="language-plaintext highlighter-rouge">1</code> disabling additional sessions on the current connection channel.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="c1">// [2] XXX - global variable to disable further channels/sessions if set</span>
<span class="cm">/* Disallow further sessions. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">no_more_sessions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">server_loop2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span> <span class="n">Authctxt</span> <span class="o">*</span><span class="n">authctxt</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">"Entering interactive session for SSH2."</span><span class="p">);</span>
        <span class="p">...</span>
	<span class="n">server_init_dispatch</span><span class="p">(</span><span class="n">ssh</span><span class="p">);</span>
        <span class="p">...</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="n">server_init_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">"server_init_dispatch"</span><span class="p">);</span>
	<span class="n">ssh_dispatch_set</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">SSH2_MSG_GLOBAL_REQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_input_global_request</span><span class="p">);</span>
        <span class="n">ssh_dispatch_set</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">SSH2_MSG_CHANNEL_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_input_channel_open</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>

<span class="n">server_input_global_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">...</span>
 <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="s">"no-more-sessions@openssh.com"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// [3] XXX - if the client sends the "no-more-sessions@openssh.com" dispatch cmd to the server the no_more_sessions is set to "1".</span>
        <span class="n">no_more_sessions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="p">...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Likewise if the <code class="language-plaintext highlighter-rouge">SSH2_MSG_CHANNEL_OPEN</code> dispatch command is received. The <code class="language-plaintext highlighter-rouge">server_input_channel_open(...)</code> function is called.</p>

<p>This function eventually calls <code class="language-plaintext highlighter-rouge">server_request_session(...)</code> that checks if <code class="language-plaintext highlighter-rouge">no_more_sessions</code> is <code class="language-plaintext highlighter-rouge">&gt; 0</code> and exits if yes.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="n">server_input_channel_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">Channel</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="s">"session"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	        <span class="c1">// XXX - A "session" is requested from ssh_session2_open()</span>
		<span class="c1">// XXX - the following function will check no_more_sessions and fail/return</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">server_request_session</span><span class="p">(</span><span class="n">ssh</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="p">...</span>
<span class="p">}</span>

<span class="n">server_request_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
        <span class="n">Channel</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

        <span class="n">debug</span><span class="p">(</span><span class="s">"input_session_request"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshpkt_get_end</span><span class="p">(</span><span class="n">ssh</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">sshpkt_fatal</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s">"%s: parse packet"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="c1">// [3] XXX - checks no_more_sessions is 1 and disconnects / returns </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">no_more_sessions</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ssh_packet_disconnect</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="s">"Possible attack: attempt to open a "</span>
                    <span class="s">"session after additional sessions disabled"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// [4] XXX - open session if all checks passed</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">channel_new</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="s">"session"</span><span class="p">,</span> <span class="n">SSH_CHANNEL_LARVAL</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*window size*/</span><span class="mi">0</span><span class="p">,</span> <span class="n">CHAN_SES_PACKET_DEFAULT</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="s">"server-session"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">session_open</span><span class="p">(</span><span class="n">the_authctxt</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">debug</span><span class="p">(</span><span class="s">"session open failed, free channel %d"</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>
                <span class="n">channel_free</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">channel_register_cleanup</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">session_close_by_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="sshc"><span class="me-2">ssh.c</span><a href="#sshc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Having looked at the server related code above we are familiar with the specific <code class="language-plaintext highlighter-rouge">*ssh</code> dispatch commands.</p>

<p>Next checking the client code that initiates a connection and what <code class="language-plaintext highlighter-rouge">*ssh</code> dispatch commands are sent &amp; when:</p>

<p>The <code class="language-plaintext highlighter-rouge">ssh_session2(...)</code> function is called from the <code class="language-plaintext highlighter-rouge">main(...)</code> function in <code class="language-plaintext highlighter-rouge">ssh.c</code> when initiating a connection with a server.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ssh_session2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssh_conn_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
        <span class="cm">/* If we don't expect to open a new session, then disallow it */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">control_master</span> <span class="o">==</span> <span class="n">SSHCTL_MASTER_NO</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">compat</span> <span class="o">&amp;</span> <span class="n">SSH_NEW_OPENSSH</span><span class="p">))</span> <span class="p">{</span>
		<span class="c1">// [1] XXX - the CLIENT sends no-more-sessions@openssh.com string to the server after the call to ssh_session2_open() has finished</span>
                <span class="n">debug</span><span class="p">(</span><span class="s">"Requesting no-more-sessions@openssh.com"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshpkt_start</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">SSH2_MSG_GLOBAL_REQUEST</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshpkt_put_cstring</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span>
                    <span class="s">"no-more-sessions@openssh.com"</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshpkt_put_u8</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshpkt_send</span><span class="p">(</span><span class="n">ssh</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">fatal_fr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">"send packet"</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>At the very start of the clients connection if the <code class="language-plaintext highlighter-rouge">ControlMaster</code> option is not set then the ssh packet starts with the <code class="language-plaintext highlighter-rouge">SSH2_MSG_GLOBAL_REQUEST</code> dispatch command 
and the <code class="language-plaintext highlighter-rouge">no-more-sessions@openssh.com</code> string disabling further sessions from being opened on that connection/channel.</p>

<h1 id="tldr-">TLDR :</h1>

<p>1) The SSH client checks if <code class="language-plaintext highlighter-rouge">ControlMaster</code> option is set via commandline or config.</p>

<p>2) Upon initial connection to a remote server the SSH client sends <code class="language-plaintext highlighter-rouge">no-more-sessions@openssh.com</code> string to the server if no <code class="language-plaintext highlighter-rouge">ControlMaster</code> option is set.</p>

<p>3) When receiving connections the SSHD server checks the initial connecting clients per-connection options. If the server receives the <code class="language-plaintext highlighter-rouge">no-more-sessions@openssh.com</code> string at this time then it sets <code class="language-plaintext highlighter-rouge">no_more_session = 1</code> server side preventing further sessions from being opened on that connection/channel by remote clients.</p>

<p>4) If a client tries to open a new session on an existing connection at this point the server will disconnect the connecting client as the <code class="language-plaintext highlighter-rouge">no_more_sessions</code> is set to <code class="language-plaintext highlighter-rouge">1</code> for this connection.</p>

<p>The OpenSSH documentation is clear about all of this behavior (but who reads docs):</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre>2.2. connection: disallow additional sessions extension
     "no-more-sessions@openssh.com"

Most SSH connections will only ever request a single session, but a
attacker may abuse a running ssh client to surreptitiously open
additional sessions under their control. OpenSSH provides a global
request "no-more-sessions@openssh.com" to mitigate this attack.

When an OpenSSH client expects that it will never open another session
(i.e. it has been started with connection multiplexing disabled), it
will send the following global request:

        byte            SSH_MSG_GLOBAL_REQUEST
        string          "no-more-sessions@openssh.com"
        char            want-reply

On receipt of such a message, an OpenSSH server will refuse to open
future channels of type "session" and instead immediately abort the
connection.

Note that this is not a general defence against compromised clients
(that is impossible), but it thwarts a simple attack.

NB. due to certain broken SSH implementations aborting upon receipt
of this message, the no-more-sessions request is only sent to OpenSSH
servers (identified by banner). Other SSH implementations may be
listed to receive this message upon request.

...

Client implementations SHOULD reject any session channel open
requests to make it more difficult for a corrupt server to attack the
client.
</pre></td></tr></tbody></table></code></div></div>

<h1 id="reading-documentation-will-make-you-a-better-hacker-">Reading documentation will make you a better hacker :</h1>

<p>A valuable source of information that generally far surpasses most tutorials found online.</p>

<p>The SSH documentation tells about three options, that when provided will enable multiplexing for SSH connections.</p>

<p>From the <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html">ssh_config manpage</a> :</p>

<p><code class="language-plaintext highlighter-rouge">ControlMaster</code>: <br />
Enables the sharing of multiple sessions over a single network connection.<br />
When set to yes, ssh(1) will listen for connections on a control socket specified using the ControlPath argument.</p>

<p><mark>Additional sessions can connect to this socket using the same ControlPath with ControlMaster set to no (the default).</mark></p>

<p>These sessions will try to reuse the master instance’s network connection rather than initiating new ones,
but will fall back to connecting normally if the control socket does not exist, or is not listening.</p>

<p>Setting this to ask will cause ssh(1) to listen for control connections, but require confirmation using ssh-askpass(1).</p>

<p>If the ControlPath cannot be opened, ssh(1) will continue without connecting to a master instance.</p>

<p>X11 and ssh-agent(1) forwarding is supported over these multiplexed connections, however the display and agent forwarded 
will be the one belonging to the master connection i.e. it is not possible to forward multiple displays or agents.</p>

<p>Two additional options allow for opportunistic multiplexing: try to use a master connection but fall back to creating a new one if one does not already exist. 
These options are: auto and autoask. The latter requires confirmation like the ask option.</p>

<p><code class="language-plaintext highlighter-rouge">ControlPath</code>:<br />
<mark>Specify the path to the control socket used for connection sharing as described in the ControlMaster section above or the string none to disable connection sharing.</mark></p>

<p>Arguments to ControlPath may use the tilde syntax to refer to a user’s home directory, the tokens described in the TOKENS section and environment variables as described in the ENVIRONMENT VARIABLES section.</p>

<p>It is recommended that any ControlPath used for opportunistic connection sharing include at least %h, %p, and %r (or alternatively %C) and be placed in a directory that is not writable by other users.<br />
This ensures that shared connections are uniquely identified.</p>

<p><code class="language-plaintext highlighter-rouge">ControlPersist</code>:<br />
<mark>When used in conjunction with ControlMaster, specifies that the master connection should remain open in the background (waiting for future client connections) after the initial client connection has been closed.</mark></p>

<p>If set to no (the default), then the master connection will not be placed into the background, and will close as soon as the initial client connection is closed.</p>

<p>If set to yes or 0, then the master connection will remain in the background indefinitely (until killed or closed via a mechanism such as the “ssh -O exit”). 
If set to a time in seconds, or a time in any of the formats documented in sshd_config(5), then the backgrounded master connection will automatically terminate after it has remained idle (with no client connections) 
for the specified time.</p>

<p>Lastly multiplexing is not available in the Windows version of OpenSSH as described <a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Project-Scope">here</a></p>

<h1 id="abusing-ssh-multiplexing-">Abusing SSH multiplexing :</h1>

<p>Placing a config file in the target users <code class="language-plaintext highlighter-rouge">~/.ssh/</code> directory is enough to enable basic lateral movement and bypass popular two-factor auth setups (ex: Google authenticator or DUO) while the admins SSH sessions are active and connected:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>ControlMaster auto
ControlPath ~/.ssh/control:%h:%p:%r
</pre></td></tr></tbody></table></code></div></div>

<h3 id="terminal-1-victim"><span class="me-2">Terminal 1 (victim)</span><a href="#terminal-1-victim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We test authentication first and verify that key-auth is required. Next we login successfully.</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss2.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss2.png" alt="image" loading="lazy"></a></p>

<p>If the victim user disconnects from the remote host while the attacker is still active the victims session will not exit cleanly :</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss3.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss3.png" alt="image" loading="lazy"></a></p>

<p>If the victim user force closes the session (ctrl-c) at this point the attackers session will be ended :</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss4.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss4.png" alt="image" loading="lazy"></a></p>

<h3 id="terminal-2-attacker"><span class="me-2">Terminal 2 (attacker)</span><a href="#terminal-2-attacker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The attacker checks the .ssh/config file in use and locates the victims ssh session.<br />
The attacker then successfully authenticates to the remote SSH server without providing the ssh-key for authentication using the multiplexed connection.</p>

<p>Note: <code class="language-plaintext highlighter-rouge">-T</code> to prevent OpenSSH from spawning a terminal which keeps logging to a minimal. <code class="language-plaintext highlighter-rouge">-v</code> adds verbosity to let the user know the connection information.</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss6.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss6.png" alt="image" loading="lazy"></a></p>

<p>If the session is force closed by the victim user the session is closed and the user is dropped back to their own console:</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss5.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss5.png" alt="image" loading="lazy"></a></p>

<p>The primitive can be much more powerful by adding the <code class="language-plaintext highlighter-rouge">ControlPersist</code> option and setting it to <code class="language-plaintext highlighter-rouge">yes</code>.</p>

<p>As we read above this option will background the multiplexed connection so its still active after the initial session is disconnected by the admin. <code class="language-plaintext highlighter-rouge">!!!</code></p>

<p>This allows the admin to disconnect cleanly and leave the multiplexed connection open in the background for the attacker to connect with.</p>

<p>Editing the config file to:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>ControlMaster auto
ControlPath ~/.ssh/control:%h:%p:%r
ControlPersist yes
</pre></td></tr></tbody></table></code></div></div>

<p>Is enough to enable silently back-grounding connections for future sessions.</p>

<p>Now if a victim user connects to a host and exits the session the attacker can act more leisurely to gain access to the same remote hosts.</p>

<p>This includes hosts protected by common 2FA setups such as Duo Security.</p>

<p>In the below tests I’ve setup <code class="language-plaintext highlighter-rouge">Google-Authenticator</code> as a MFA precaution to demonstrate bypassing it with multiplexing.</p>

<h3 id="victim"><span class="me-2">Victim</span><a href="#victim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>You can see in the first victim screen shot below it prompts for the <code class="language-plaintext highlighter-rouge">Verification code</code> then the user exits the session completely.</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss7.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss7.png" alt="image" loading="lazy"></a></p>

<h3 id="attacker"><span class="me-2">Attacker</span><a href="#attacker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The attacker locates the multiplexed socket file in use then connects to the host without providing the authentication key or the authenticator verification code:</p>

<p><a href="https://upload.wikimedia.org/assets/img/ss8.png" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/ss8.png" alt="image" loading="lazy"></a></p>

<h1 id="detection">Detection</h1>

<p>Not really my thing.</p>

<p>If using the ControlPersist option the initial connection stays alive and is visible in active connections using <code class="language-plaintext highlighter-rouge">netstat</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>tcp        0      0 x.x.x.x:50356     54.152.139.0:22         ESTABLISHED 12832/ssh: /home/x/
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">ps aux</code> usually shows the socket file in use also :</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>x        12832  0.0  0.0  12244  2688 ?        Ss   09:50   0:00 ssh: /home/x/.ssh/control:54.152.139.0:22:ubuntu [mux]
</pre></td></tr></tbody></table></code></div></div>

<p>Check your <code class="language-plaintext highlighter-rouge">.ssh</code> directory once in awhile to verify the config hasn’t been tampered with or any ssh keys added to authorized_keys file.</p>

<h1 id="eof">EOF</h1>

<p>Metlstorm suggested that RDP may be vulnerable to similar in the past in his talk. 🤷‍♂️</p>

<p>Audit tip: Check SSH implementations when auditing to see if they disallow further sessions after initial session creation.</p>

<p>Exercise for readers: Other forms of session riding also exist.</p>

<p>DUO Security MFA implements a web based panel that allows admin users to create bypass-codes for other users having trouble authenticating.</p>

<p>This can be abused if an attacker gains access to an admins machine (RDP) similar to the above attack. The attacker installs a hidden browser plugin to keep the session alive on the admin panel using invisible clicks. Then when the admin is away the attacker is able to stealthily create bypass-codes using the admins session thats been kept alive.</p>

<p><a href="https://chrome.google.com/webstore/detail/session-alive/aodfoiacnmepndhojccepdcpmehjbham">Chrome Keep Session Alive Extension</a></p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/web2/">web2</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Session%20Riding%20OpenSSH%20(multiplexing)%20to%20bypass%202FA%20-%20LCFR&url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Flocal-ssh-2fa-bypass%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Session%20Riding%20OpenSSH%20(multiplexing)%20to%20bypass%202FA%20-%20LCFR&u=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Flocal-ssh-2fa-bypass%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Flocal-ssh-2fa-bypass%2F&text=Session%20Riding%20OpenSSH%20(multiplexing)%20to%20bypass%202FA%20-%20LCFR" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ens-namewrapper-bounty/">Bounty: ENS NameWrapper expiry issue</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/rescue-ens-names/">Rescuing ENS names from compromised wallets.</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/duplicate-ens-names/">Bounty: Using a Web2 bug to duplicate ENS names</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/local-ssh-2fa-bypass/">Session Riding OpenSSH (multiplexing) to bypass 2FA</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->


















            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Older">
      <p>-</p>
    </div>
  

  
    <a
      href="/posts/duplicate-ens-names/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Bounty: Using a Web2 bug to duplicate ENS names</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/lcfr_eth">LCFR</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.2.4"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

