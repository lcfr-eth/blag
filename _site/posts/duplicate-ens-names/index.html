<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Bounty: Using a Web2 bug to duplicate ENS names" />
<meta property="og:locale" content="en" />
<meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<link rel="canonical" href="http://0.0.0.0:4000/posts/duplicate-ens-names/" />
<meta property="og:url" content="http://0.0.0.0:4000/posts/duplicate-ens-names/" />
<meta property="og:site_name" content="LCFR" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-01T20:28:22-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bounty: Using a Web2 bug to duplicate ENS names" />
<meta name="twitter:site" content="@lcfr_eth" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-01T20:28:22-04:00","datePublished":"2022-05-01T20:28:22-04:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"Bounty: Using a Web2 bug to duplicate ENS names","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/posts/duplicate-ens-names/"},"url":"http://0.0.0.0:4000/posts/duplicate-ens-names/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Bounty: Using a Web2 bug to duplicate ENS names | LCFR
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="LCFR">
<meta name="application-name" content="LCFR">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Paradise_Lost_12.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">LCFR</a>
    <p class="site-subtitle fst-italic mb-0">nobody</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/lcfr-eth"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/lcfr_eth"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['nobody','lcfr.io'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Bounty: Using a Web2 bug to duplicate ENS names</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Bounty: Using a Web2 bug to duplicate ENS names</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1651451302"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May  1, 2022
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/lcfr_eth">LCFR</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1810 words"
>
  <em>10 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Bounty: Using a Web2 bug to duplicate ENS names</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Bounty: Using a Web2 bug to duplicate ENS names</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <p><a href="https://upload.wikimedia.org/assets/img/lost.jpeg" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/lost.jpeg" alt="image" loading="lazy"></a></p>

<h5 id="quick-links"><span class="me-2">Quick Links</span><a href="#quick-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>
<p><a href="#about-ens">About ENS: Decentralized Domain Name System</a><br />
<a href="#ens-registration--metadata-explained">ENS Registration &amp; Metadata explained</a><br />
<a href="#ens-subgraph-service">ENS Subgraph Service</a><br />
<a href="#ens-metadata-service">ENS Metadata Service</a><br />
<a href="#zwj-zwnj-zwsp-">ZWJ, ZWNJ, ZWSP ?</a><br />
<a href="#null-bytes--string-termination">Null-bytes &amp; String termination</a><br />
<a href="#idea">Idea</a><br />
<a href="#results">Results</a><br />
<a href="#the-patchs">The Patche(s)</a>  <br />
<a href="#revisited-122022">Revisited 12/2022</a><br />
<a href="#reward">Reward</a></p>

<h1 id="about-ens-decentralized-domain-name-system">About ENS: Decentralized Domain Name System</h1>

<p>ENS (Ethereum Name Service) is a decentralized domain name system built on Ethereum. Its goal is to make the process of accessing decentralized websites, applications, and resources much easier and user-friendly.</p>

<p>ENS replaces complicated addresses such as “0x742d35Cc6634C0532925a3b844Bc454e4438f44e” with human-readable names like “myaddress.eth”. This allows users to remember and share their Ethereum addresses more easily, just like with traditional domain name.</p>

<p><a href="https://docs.ens.domains/">Learn more about ENS</a></p>

<h1 id="ens-registration--metadata-explained">ENS Registration &amp; Metadata explained</h1>

<p>When registering an ENS name you are registering the keccak256 “hash” of the name. The hash of the name and owner are stored as a mapping in the contract. An event is emitted that is eventually used to create the metadata entry for a given name. As the data is hashed its not possible to reverse to determine the plain text name directly. This keccak256 hash of the name when converted to a uint256 is the names TokenID.</p>

<p>ENS Metadata is two parts. The Subgraph and the Metadata services. The subgraph services is responsible for catching contract events and adding them to a queryable database.</p>

<p>The metadata service queries this database to return a json object from the database results of a name or tokenId.</p>

<p>dApps query the metadata service URL for information on a name/tokenId.</p>

<h3 id="ens-subgraph-service"><span class="me-2">ENS Subgraph Service</span><a href="#ens-subgraph-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The subgraph catches events emitted from the various ENS contracts and adds them to the subgraph database for easy querying from web UI or by direct API.</p>

<p><a href="https://thegraph.com/hosted-service/subgraph/ensdomains/ens">Public ENS Subgraph instance via TheGraph</a><br />
<a href="https://github.com/ensdomains/ens-subgraph">ENS Subgraph Daemon code</a><br />
<a href="https://docs.ens.domains/contract-api-reference/subgraphdata">ENS Subgraph documentation</a></p>

<p>subgraph.yaml snippet which defines a contracts, events and event handler functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>  - kind: ethereum/contract
    name: EthRegistrarController
    network: mainnet
    source:
      address: '0x283Af0B28c62C092C9727F1Ee09c02CA627EB7F5' &lt;--- this is the contract address to watch
      abi: EthRegistrarController
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      file: ./src/ethRegistrar.ts
      entities:
        - Registration
      abis:
        - name: EthRegistrarController
          file: ./abis/EthRegistrarController.json
      eventHandlers:
        - event: &gt;-
            NameRegistered(string,indexed bytes32,indexed address,uint256,uint256) &lt;--- this is the event to catch for
            handler: handleNameRegisteredByController &lt;--- this is the function that handles the events from the contract

</pre></td></tr></tbody></table></code></div></div>
<p>Below is an example event handler to handle registration events from the Controller contract.</p>

<div class="language-typescript highlighter-rouge"><div class="code-header">
        <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">function</span> <span class="nf">handleNameRegisteredByController</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">ControllerNameRegisteredEvent</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nf">setNamePreimage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">label</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">baseCost</span><span class="p">.</span><span class="nf">plus</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">premium</span><span class="p">))</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="ens-metadata-service"><span class="me-2">ENS Metadata Service</span><a href="#ens-metadata-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>This is where a names metadata is stored per name/tokenID. This is the endpoint in which services query to return information about a supplied name or tokenId.</p>

<p>https://metadata.ens.domains</p>

<p>This queiries theGraph instance to return the metadata for a given name/tokenID.</p>

<h1 id="zwj-zwnj-zwsp-">ZWJ, ZWNJ, ZWSP ?</h1>

<p>ZWJ, ZWNJ, and ZWSP are all individual byte sequences to join or space unicode characters properly for display purposes that essentially end up “render” as an invisible character in a string.</p>

<p><a href="https://en.wikipedia.org/wiki/Zero-width_joiner">ZWJ - Zero Width Joiner</a>.<br />
<a href="https://en.wikipedia.org/wiki/Zero-width_non-joiner">ZWNJ - Zero With Non Joiner</a>.<br />
<a href="https://en.wikipedia.org/wiki/Zero-width_space">ZWSP = Zero Width Space</a>.</p>

<p>Each of these are actually three individual bytes in sequence as seen below:</p>

<p><a href="https://www.fileformat.info/info/unicode/char/200d/index.htm">ZWJ - 0xE2 0x80 0x8D</a><br />
<a href="https://www.fileformat.info/info/unicode/char/200c/index.htm">ZWNJ - 0xE2 0x80 0x8C</a><br />
<a href="https://www.fileformat.info/info/unicode/char/200b/index.htm">ZWSP - 0xE2 0x80 0x8B</a></p>

<p>Appending or prepending any of these byte sequences to an ENS name results in an invisible character in-place. To create a name with a ZWNJ for example one could register an ENS name such as “testzwsp”+u”\u200B” in python to create an ENS name with an invisible character appended to the end of the name. The characters are invisible but still show in the names length field on metadata.</p>

<p>An example of a name with a ZWSP was registered “testzwsp”+u”\u200B”. This will create an ENS name of length 9 total. 8 for (“testzwsp”) + 1 for the invisible unicode zero width space we inserted after the text.</p>

<p><a href="https://metadata.ens.domains/mainnet/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/87168065001888073846593886985622493818274710011410357743988130633182109658955">testzwsp.eth metadata</a></p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"is_normalized"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"[0xc0b7...6f4b].eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="s2">"[0xc0b7...6f4b].eth, an ENS name. (testzwsp​.eth is not in normalized form) ⚠️ ATTENTION: This name contains non-ASCII characters as shown above. Please be aware that there are characters that look identical or very similar to English letters, especially characters from Cyrillic and Greek. Also, traditional Chinese characters can look identical or very similar to simplified variants. For more information: https://en.wikipedia.org/wiki/IDN_homograph_attack"</span><span class="p">,</span><span class="w">

  </span><span class="nl">"attributes"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Created Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1672119599000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">9</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Segment Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">9</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Character Set"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"mixed"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Registration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1672119599000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Expiration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1674538799000</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name_length"</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segment_length"</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span><span class="w">
  </span><span class="nl">"url"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/0xc0b7605c7c38d15e9babd8edbde1427b6fe8d926104130267dc6e8acdcd66f4b/image"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image_url"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/0xc0b7605c7c38d15e9babd8edbde1427b6fe8d926104130267dc6e8acdcd66f4b/image"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><a href="https://upload.wikimedia.org/assets/img/duplicateensbounty/zwsp.PNG" class="popup img-link  shimmer"><img src="https://upload.wikimedia.org/assets/img/duplicateensbounty/zwsp.PNG" alt="image" loading="lazy"></a></p>

<p>As pictured you can see the length of the name is X which is the length of “” + the 3 bytes for the ZWNJ sequence. Knowing this a smart ENS user can avoid scams by checking the length of a name to verify if it is the intended name.</p>

<h1 id="null-bytes--string-termination">Null-bytes &amp; String termination</h1>

<p>placeholder</p>

<h1 id="idea">Idea</h1>

<p>Instead of adding a ZWJ or a space character to mint a ‘duplicate’ name. I’ll try a null-byte to mint a duplicate name as its a single byte vs a sequence.</p>

<h1 id="results">Results</h1>

<p><a href="https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/21408738346033573782297054604318283394034443274101412154976884646337787450239">real souls.eth metadata</a></p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"is_normalized"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="s2">"souls.eth, an ENS name."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"attributes"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Created Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1573148261000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Segment Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Character Set"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"letter"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Registration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1646418606000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Expiration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1677975558000</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name_length"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segment_length"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"url"</span><span class="p">:</span><span class="s2">"https://app.ens.domains/name/souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"background_image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/avatar/souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x2f54ea9f8401e3f2ecb79b9bf6ca7581eb0100529a3283083b959dbb792bd37f/image"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image_url"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x2f54ea9f8401e3f2ecb79b9bf6ca7581eb0100529a3283083b959dbb792bd37f/image"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><a href="https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/3952704116753594465626453052297191666829096611916680535498635886104442511571">fake souls.eth metadata</a></p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"is_normalized"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="s2">"souls.eth, an ENS name."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"attributes"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Created Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1671569999000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Segment Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Character Set"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"letter"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Registration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1671569999000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Expiration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1703126951000</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name_length"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segment_length"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"url"</span><span class="p">:</span><span class="s2">"https://app.ens.domains/name/souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"background_image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/avatar/souls.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x08bd26b83793d0d667a993e5c2499c959245f0232c3a6c39d0dfb7d365cf20d3/image"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image_url"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x08bd26b83793d0d667a993e5c2499c959245f0232c3a6c39d0dfb7d365cf20d3/image"</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><a href="https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/24200900942460299581294029538738684782160326766579606917767243798520494602098">Fake vitalik.eth metadata</a></p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"is_normalized"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"vitalik.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="s2">"vitalik.eth, an ENS name."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"attributes"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Created Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1673268731000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">7</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Segment Length"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">7</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Character Set"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"letter"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Registration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1673268731000</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"trait_type"</span><span class="p">:</span><span class="s2">"Expiration Date"</span><span class="p">,</span><span class="nl">"display_type"</span><span class="p">:</span><span class="s2">"date"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">1675687931000</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name_length"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segment_length"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="w">
  </span><span class="nl">"url"</span><span class="p">:</span><span class="s2">"https://app.ens.domains/name/vitalik.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"background_image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/avatar/vitalik.eth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x3581397a478dcebdc1ee778deed625697f624c6f7dbed8bb7f780a6ac094b772/image"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image_url"</span><span class="p">:</span><span class="s2">"https://metadata.ens.domains/mainnet/0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85/0x3581397a478dcebdc1ee778deed625697f624c6f7dbed8bb7f780a6ac094b772/image"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>The name is registered and the events are emitted. The name is added to the subgraph intance which results in a valid metadata object being returnable from the metadata service. Checking the metadata reveals two discoveries.</p>

<p>The first is that the length of the name is misrepresented and does not account for the additional null-byte.</p>

<p>The second is that there is no visible warning about “unicode” characters as a single null-byte is not considered unicode. It appears a null-byte bypasses the normalization check that would otherwise display a visible alert to users viewing the name on NFT marketplaces.</p>

<p>Thus names minted with an appended null-byte create a hard-to-distinguish duplicate token / name as the length is wrong and no visible warning is displayed that users are used to when looking for duplicate/fake names.</p>

<p>As an example of this bug I originally registered two different <code class="language-plaintext highlighter-rouge">sload.eth</code> names. Which can be viewed at the metadata links below.</p>

<p>Screen shots provided as well displaying both names length record as displaying only 5 and not 6 as well as both names being displayable on Opensea, LooksRare and X2Y2.</p>

<p>We can see two “identical” names are created in the metadata service using the null-byte technique causing the names lengths to be misrepresented. We say identical as the length is misrepresented as only the length of the name without the additional null-byte as the string appears to have been terminated before being processed by the subgraph ENS service.</p>

<p>The string termination also bypasses the normalization check’s so no visual alerts are added to the name similar to the visible alerts with unicode characters detected.</p>

<h1 id="the-patchs">The patch(s)</h1>

<p>Reviewing github commits for the ENS subgraph these two commits appeared relevent:</p>

<p><a href="https://github.com/ensdomains/ens-subgraph/commit/5f97205606a239a6db657d97394dfadf81510a20">Fix label hashing check</a><br />
<a href="https://github.com/ensdomains/ens-subgraph/commit/a7ec9017e0498ab82e09f0de6157923d0aec9057">Fix hash check, add dot check</a></p>

<p>The patch also fixes another <a href="https://medium.com/@hacxyk/how-we-spoofed-ens-domains-52acea2079f6">vulnerability</a> reported around the same time which allowed a user to create / mint spoofed ERC721 “subdomains” from names they didn’t own.</p>

<p>TLDR of the other vulnerability: by prepending your chosen subdomain and a “.” character to create a new spoofed name name that looks like a subdomain.</p>

<p>for example coke.eth - they could have registered drink.coke.eth while not owning coke.eth. At current time ENS subdomains are non transferable and this should be a huge red flag that the name is “fake” on markets.</p>

<div class="language-typescript highlighter-rouge"><div class="code-header">
        <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">setNamePreimage</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">label</span><span class="p">:</span> <span class="nx">Bytes</span><span class="p">,</span> <span class="nx">cost</span><span class="p">:</span> <span class="nx">BigInt</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">labelHash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">ByteArray</span><span class="p">.</span><span class="nf">fromUTF8</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">labelHash</span><span class="p">.</span><span class="nf">equals</span><span class="p">(</span><span class="nx">label</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span>
      <span class="dl">"</span><span class="s2">Expected '{}' to hash to {}, but got {} instead. Skipping.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">labelHash</span><span class="p">.</span><span class="nf">toHex</span><span class="p">(),</span> <span class="nx">label</span><span class="p">.</span><span class="nf">toHex</span><span class="p">()]</span>
    <span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid label '{}'. Skipping.</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">domain</span> <span class="o">=</span> <span class="nx">Domain</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nf">keccak256</span><span class="p">(</span><span class="nf">concat</span><span class="p">(</span><span class="nx">rootNode</span><span class="p">,</span> <span class="nx">label</span><span class="p">)).</span><span class="nf">toHex</span><span class="p">())</span><span class="o">!</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">labelName</span> <span class="o">!==</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">domain</span><span class="p">.</span><span class="nx">labelName</span> <span class="o">=</span> <span class="nx">name</span>
    <span class="nx">domain</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.eth</span><span class="dl">'</span>
    <span class="nx">domain</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">registration</span> <span class="o">=</span> <span class="nx">Registration</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nf">toHex</span><span class="p">());</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">registration</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nx">labelName</span> <span class="o">=</span> <span class="nx">name</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nx">cost</span> <span class="o">=</span> <span class="nx">cost</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">handleNameRegisteredByControllerOld</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">ControllerNameRegisteredEventOld</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nf">setNamePreimage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">label</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">cost</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h1 id="revisited-122022">Revisited 12/2022</h1>
<p>It seems an oversight of the subgraph instances configuration subgraph.yaml file and eventhandler definitions lead to this bug still existing and being “exploitable”.</p>

<p>It appears there are two handlers for NameRegistered events - One from the Registrar controller which input is passed to SetPreimage() correctly. How ever there is another definition for NameRegistered events from the baseRegistrar contract which registers &amp; emits events first before other contracts. Allowing the malformed name to be inserted into the metadata service regardless of the patch.</p>

<p>The first definition for the NameRegistered event / handler calls a handler which is not calling SetPreimage() correctly.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>  - kind: ethereum/contract
    name: BaseRegistrar
    network: mainnet
    source:
      address: "0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85"
      abi: BaseRegistrar
      startBlock: 9380410
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      file: ./src/ethRegistrar.ts
      entities:
        - Registration
        - NameRegistered
        - NameRenewed
        - NameTransferred
      abis:
        - name: BaseRegistrar
          file: ./abis/BaseRegistrar.json
      eventHandlers:
        - event: "NameRegistered(indexed uint256,indexed address,uint256)"
          handler: handleNameRegistered
</pre></td></tr></tbody></table></code></div></div>

<p>The event handler:</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">function</span> <span class="nf">handleNameRegistered</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">NameRegisteredEvent</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nf">toHex</span><span class="p">())</span>
  <span class="nx">account</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>

  <span class="kd">let</span> <span class="nx">label</span> <span class="o">=</span> <span class="nf">uint256ToByteArray</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">registration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Registration</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nf">toHex</span><span class="p">())</span>
  <span class="kd">let</span> <span class="nx">domain</span> <span class="o">=</span> <span class="nx">Domain</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nf">keccak256</span><span class="p">(</span><span class="nf">concat</span><span class="p">(</span><span class="nx">rootNode</span><span class="p">,</span> <span class="nx">label</span><span class="p">)).</span><span class="nf">toHex</span><span class="p">())</span><span class="o">!</span>

  <span class="nx">registration</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nx">registrationDate</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nx">expiryDate</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">expires</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nx">registrant</span> <span class="o">=</span> <span class="nx">account</span><span class="p">.</span><span class="nx">id</span>

  <span class="kd">let</span> <span class="nx">labelName</span> <span class="o">=</span> <span class="nx">ens</span><span class="p">.</span><span class="nf">nameByHash</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nf">toHexString</span><span class="p">())</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">labelName</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">domain</span><span class="p">.</span><span class="nx">labelName</span> <span class="o">=</span> <span class="nx">labelName</span>
    <span class="nx">registration</span><span class="p">.</span><span class="nx">labelName</span> <span class="o">=</span> <span class="nx">labelName</span>
  <span class="p">}</span>
  <span class="nx">domain</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>
  <span class="nx">registration</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>

  <span class="kd">let</span> <span class="nx">registrationEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NameRegistered</span><span class="p">(</span><span class="nf">createEventID</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nx">registration</span> <span class="o">=</span> <span class="nx">registration</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nx">blockNumber</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span><span class="p">.</span><span class="nf">toI32</span><span class="p">()</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nx">transactionID</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">hash</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nx">registrant</span> <span class="o">=</span> <span class="nx">account</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nx">expiryDate</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">expires</span>
  <span class="nx">registrationEvent</span><span class="p">.</span><span class="nf">save</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I registered a copy of an ENS name I already owned “souls.eth” to verify the bug was indeed still alive.</p>

<p>The metadata links and screen shots are provided below:</p>

<h1 id="reward">Reward</h1>
<p>Awarded $45000 USDC originally<br />
Awarded $20000 USDC re-reporting<br />
Total: $65,000 USDC</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/web3/">web3</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Bounty:%20Using%20a%20Web2%20bug%20to%20duplicate%20ENS%20names%20-%20LCFR&url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fduplicate-ens-names%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Bounty:%20Using%20a%20Web2%20bug%20to%20duplicate%20ENS%20names%20-%20LCFR&u=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fduplicate-ens-names%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2Fduplicate-ens-names%2F&text=Bounty:%20Using%20a%20Web2%20bug%20to%20duplicate%20ENS%20names%20-%20LCFR" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ens-namewrapper-bounty/">Bounty: ENS NameWrapper expiry issue</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/rescue-ens-names/">Rescuing ENS names from compromised wallets.</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/duplicate-ens-names/">Bounty: Using a Web2 bug to duplicate ENS names</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/local-ssh-2fa-bypass/">Session Riding OpenSSH (multiplexing) to bypass 2FA</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->


















            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  
    
  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/ens-namewrapper-bounty/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1671928102"
  data-df="ll"
  
>
  Dec 24, 2022
</time>

              <h4 class="pt-0 my-2">Bounty: ENS NameWrapper expiry issue</h4>
              <div class="text-muted">
                <p>Quick Links About ENS and ENS Subdomains About the NameWrapper Finding the bug Proof of Concept Patch Reward  About ENS and ENS Subdomains Currently Ethereum Name Service or just ENS for short is a...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/rescue-ens-names/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1652920102"
  data-df="ll"
  
>
  May 18, 2022
</time>

              <h4 class="pt-0 my-2">Rescuing ENS names from compromised wallets.</h4>
              <div class="text-muted">
                <p>Recently we had a client message our support channel asking about strange transactions.  Shortly after we determined the users wallet had been compromised and a drainer/sweeper script attached to t...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/local-ssh-2fa-bypass/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Session Riding OpenSSH (multiplexing) to bypass 2FA</p>
    </a>
  

  
    <a
      href="/posts/rescue-ens-names/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Rescuing ENS names from compromised wallets.</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/lcfr_eth">LCFR</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.2.4"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

